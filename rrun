#!/usr/bin/sh
# A bash harness around r, to add parameters
# if parameters are missing, and referenced in file, then rrun will error
#
# timp@pizey.net
# 2011/02/17
#

usage="Usage: [var=val ]* input.R"

command=`basename $0`
# typically rrun.R
tempFile="$command.R"

# We require at least one parameter
if [ $# -lt 1 ]
then 
  echo $usage && exit 0 
fi

#setup temporary file, overwrites any existing one
echo "# Temporary file generated by $command" > $tempFile
echo "# Date: `date`" >> $tempFile
echo "# Command: $command $@" >> $tempFile
echo "#" >> $tempFile

# distinguish between file arguments and r statementds
FOUND=-1
for var in "$@"
do
  if [ -e $var ] 
  then
    if [ $FOUND -ne -1 ] 
    then 
      echo "One file ($file) already defined; cannot define another ($var)" 
      echo $usage && exit 0
    fi
    file=$var
    FOUND=0
  else
    echo $var >>$tempFile
  fi
done

if [ $FOUND -ne 0 ]
then
  echo "No input r script found"
  echo $usage && exit 0 
fi


cat $file >> $tempFile

# writes stdout, stderr into file
#r CMD BATCH --quiet --vanilla  run.R 
# writes stdout, stderr to console
r  --quiet --vanilla --file=$tempFile 

#eof
